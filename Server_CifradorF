import socket
from Crypto.Cipher import ChaCha20
from Crypto.Random import get_random_bytes

def run_chacha_server():
    HOST = '127.0.0.1'
    PORT = 65432

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        s.bind((HOST, PORT))
        s.listen(1)
        print(f"Servidor ChaCha20 escuchando en {HOST}:{PORT}")
        
        conn, addr = s.accept()
        with conn:
            print(f"Conexión establecida desde {addr}")
            
            # Generar clave y nonce específicos para ChaCha20
            key = get_random_bytes(32)  # Clave de 256 bits
            nonce = get_random_bytes(12)  # Nonce de 12 bytes
            conn.sendall(key + nonce)  # Enviar parámetros
            
            # Configurar cifrador
            cipher = ChaCha20.new(key=key, nonce=nonce)
            
            # Recibir y descifrar mensajes
            while True:
                data = conn.recv(1024)
                if not data: break
                decrypted = cipher.decrypt(data)
                print(f"Mensaje descifrado: {decrypted.decode()}")

if __name__ == "__main__":
    run_chacha_server()